---
import MainLayout from '../layouts/MainLayout.astro';
import DataSecurityBanner from '../components/DataSecurityBanner.astro';

const { user } = Astro.locals;

if(!user){
  return Astro.redirect('/login')
}

const africanCountries = [
  "Algérie", "Angola", "Bénin", "Botswana", "Burkina Faso", "Burundi", 
  "Cabo Verde", "Cameroun", "République centrafricaine", "Tchad", "Comores", 
  "République démocratique du Congo", "République du Congo", "Côte d'Ivoire", 
  "Djibouti", "Égypte", "Guinée équatoriale", "Érythrée", "Eswatini", 
  "Éthiopie", "Gabon", "Gambie", "Ghana", "Guinée", "Guinée-Bissau", 
  "Kenya", "Lesotho", "Libéria", "Libye", "Madagascar", "Malawi", "Mali", 
  "Mauritanie", "Maurice", "Maroc", "Mozambique", "Namibie", "Niger", 
  "Nigéria", "Rwanda", "Sao Tomé-et-Principe", "Sénégal", "Seychelles", 
  "Sierra Leone", "Somalie", "Afrique du Sud", "Soudan du Sud", "Soudan", 
  "Tanzanie", "Togo", "Tunisie", "Ouganda", "Zambie", "Zimbabwe"
];
---

<MainLayout title="Paramètres" showSidebar={true}>
  <div class="max-w-3xl mx-auto">
    <h1 class="text-2xl font-bold text-gray-900 mb-6">Paramètres du compte</h1>
    
    <DataSecurityBanner />
    
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-lg font-medium text-gray-900">Informations personnelles</h2>
        <p class="mt-1 text-sm text-gray-500">Mettez à jour vos informations personnelles.</p>
      </div>
      <form method="POST">
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
          <div>
            <label for="fullName" class="block text-sm font-medium text-gray-700">Nom complet</label>
            <input 
              type="text" 
              id="fullName" 
              name="fullName" 
              value={user.fullName}
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              value={user.email}
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          
          <div>
            <label for="organization" class="block text-sm font-medium text-gray-700">Organisation</label>
            <input 
              type="text" 
              id="organization" 
              name="organization" 
              value={user.organization}
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          
          <div>
            <label for="country" class="block text-sm font-medium text-gray-700">Pays</label>
            <select 
              id="country" 
              name="country" 
              class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
            >
              <option value="" disabled selected={!user.country}>-- Choisir un pays --</option>
              {africanCountries.map(country => (
                <option value={country} selected={user.country === country}>{country}</option>
              ))}
            </select>
          </div>
          
          <div>
            <label for="role" class="block text-sm font-medium text-gray-700">Rôle</label>
            <input 
              type="text" 
              id="role" 
              name="role" 
              value={user.role}
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
        </div>
        
        <div class="flex justify-end">
          <button 
            type="submit" 
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Sauvegarder
          </button>
        </div>
      </div>
      </form> 
    </div>
   
    
    <div class="bg-white shadow-md rounded-lg overflow-hidden mt-8">
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-lg font-medium text-gray-900">Changer le mot de passe</h2>
        <p class="mt-1 text-sm text-gray-500">Assurez-vous que votre compte utilise un mot de passe long et aléatoire pour rester sécurisé.</p>
      </div>
      
      <div class="p-6 space-y-6">
        <div class="space-y-4">
          <div>
            <label for="current_password" class="block text-sm font-medium text-gray-700">Mot de passe actuel</label>
            <input 
              type="password" 
              id="current_password" 
              name="current_password" 
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          
          <div>
            <label for="new_password" class="block text-sm font-medium text-gray-700">Nouveau mot de passe</label>
            <input 
              type="password" 
              id="new_password" 
              name="new_password" 
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          
          <div>
            <label for="confirm_password" class="block text-sm font-medium text-gray-700">Confirmer le mot de passe</label>
            <input 
              type="password" 
              id="confirm_password" 
              name="confirm_password" 
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
        </div>
        
        <div class="flex justify-end">
          <button 
            type="button" 
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            Changer le mot de passe
          </button>
        </div>
      </div>
    </div>
  </div>
</MainLayout>
<script>
  import { actions } from 'astro:actions';
  import { navigate } from 'astro:transitions/client';

  const form = document.querySelector('form');
  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    const formData = new FormData(form);
    const { error } = await actions.profile.updateProfile(formData);
    if (!error) navigate('/dashboard');
  })
</script>